---
title: "Lab Data"
author: "Stephen Roecker"
date: "December 19, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---


# LDM Access

```{r access}

# only work in 32-bit R version

library(RODBC)

con <- odbcConnectAccess(access.file = "C:/Users/stephen.roecker/Nextcloud/data/ldm/NCSS_Lab_Data_Mart_09142018.mdb")
(access_names <- sqlTables(con))
idx <- !grepl("MSys", access_names$TABLE_NAME)
ldm_access <- lapply(access_names$TABLE_NAME[idx], function(x) sqlFetch(con , x, as.is = TRUE))
names(ldm_access) <- access_names$TABLE_NAME[idx]
odbcClose(con)
# save(ldm_access, file = "C:/Users/stephen.roecker/Nextcloud/data/NCSS_Lab_Data_Mart_09142018.RData")
# close and open 64-bit R version
load(file = "C:/Users/stephen.roecker/Nextcloud/data/NCSS_Lab_Data_Mart_09142018.RData")

```



# LDM Sqlite

```{r sqlite}

library(DBI)

con <- dbConnect(RSQLite::SQLite(), "C:/Users/stephen.roecker/Nextcloud/data/ldm/LDM-compact_20191231.sqlite")
# area <- read.csv("C:/Users/Stephen.Roecker/Nextcloud/data/ldm/lab_area.txt", stringsAsFactors = FALSE)
# dbCreateTable(con, "area", area)
(ldm_names <- dbListTables(con))
ldm <- lapply(ldm_names, function(x) dbReadTable(con , x))
names(ldm) <- ldm_names
dbDisconnect(con)
# save(ldm, file = "C:/Users/steph/Nextcloud/data/ldm/LDM-compact_20191231.RData")
load(file = "C:/Users/stephen.roecker/Nextcloud/data/ldm/LDM-compact_20191231.RData")

```



# spatial

```{r spatial}

# upper colorado river basin
ucrb <- read_sf(dsn = "C:/Users/Stephen.Roecker/Nextcloud/projects/2020_methodology_comparison", layer = "CO_River_watershed_Meade_alb")
ucrb <- st_transform(ucrb, 5070)


# sapolygon
# ssa <- read_sf(dsn = "D:/geodata/soils/SSURGO_CONUS_FY19.gdb", layer = "SAPOLYGON", precision = 1)
# ssa <- rmapshaper::ms_simplify(ssa)
# save(ssa, file = "D:/geodata/soils/SSURGO_CONUS_FY19_SAPOLYGON.RData")
load(file = "D:/geodata/soils/SSURGO_CONUS_FY19_SAPOLYGON.RData")
ssa <- st_transform(ssa, 5070)
# ssa_b <- st_buffer(ssa, 10000)
bb <- st_bbox(ssa)


# states
st <- us_states()
st <- st_transform(st, 5070)


# nasis sites
s_sf <- {
  s ->.;
  subset(., complete.cases(x_std, y_std)) ->.; # & !is.na(pedlabsampnum)
  within(., {
    x = ifelse(is.na(x), x_std, x)
    y = ifelse(is.na(y), y_std, y)
    }) ->.;
  st_as_sf(., coords = c("x_std", "y_std"), crs = 4326) ->.;
  st_transform(., 5070) ->.;
  }


# ldm snapshot
l_sf <- {
  ldm$nasis_site ->.;
  # merge(ldm_access$NCSS_Pedon_Lab_Data, s, by.x = "user_pedon_id", by.y = "upedonid", all.x = TRUE) ->.;
  within(., {
    x_std = longitude_std_decimal_degrees
    y_std = latitude_std_decimal_degrees
    longitude_minutes = ifelse(is.na(longitude_minutes), 0, longitude_minutes)
    longitude_seconds = ifelse(is.na(longitude_seconds), 0, longitude_seconds)
    latitude_minutes  = ifelse(is.na(latitude_minutes),  0, latitude_minutes)
    latitude_seconds  = ifelse(is.na(latitude_seconds),  0, latitude_seconds)
    latdd = (longitude_degrees + longitude_minutes / 60 + longitude_seconds / 60) * -1
    londd =  latitude_degrees  + latitude_minutes  / 60 + latitude_seconds  / 60
    x_std = ifelse(is.na(x_std), londd, x_std)
    y_std = ifelse(is.na(y_std), latdd, y_std)
    }) ->.;
  subset(., complete.cases(x_std, y_std)) ->.;
  # subset(., complete.cases(x_std, y_std)) ->.;
  st_as_sf(.,
           coords = c("x_std", "y_std"),
           # coords = c("x_std", "y_std"), 
           crs = 4326
           ) ->.;
  st_transform(., 5070)
  }
table(substr(l_sf$areasymbol, 1, 2))

ldm_s <- merge(ldm$nasis_ncss, s[c("pedlabsampnum", "x", "y", "areasymbol", "utmzone", "utmeasting", "utmnorthing", "horizdatnm")], by = "pedlabsampnum", all.x = TRUE)
table(substr(ldm_s$areasymbol, 1, 2))[c("IL", "IN", "MI", "MN", "MO", "OH", "WI")]

ldm_s2 <- merge(ldm_s, ldm_access$NCSS_Site_Location[c("siteiid", "county_code")], by = "siteiid", all.x = TRUE)
ldm_s2 <- within(ldm_s2, {
  county_code = as.character(county_code)
  areasymbol  = ifelse(is.na(areasymbol), county_code, areasymbol)
})
ldm_s2 <- {
  ldm_s2 ->.;
  subset(., complete.cases(x, y)) ->.;
  st_as_sf(., coords = c("x", "y"), crs = 4326) ->.;
  st_transform(., 5070)
}

table(substr(ldm_s2$areasymbol, 1, 2))[c("IA", "IL", "IN", "MI", "MN", "MO", "OH", "WI")]
idx <- with(ldm_s2, !complete.cases(x, y))
table(substr(ldm_s2$areasymbol[idx], 1, 2))[c("IA", "IL", "IN", "MI", "MN", "OH", "WI")]

test3 = subset(ldm_s2, !complete.cases(x, y) & complete.cases(utmeasting, utmnorthing, utmzone, horizdatnm))

```



# intersect

```{r }

idx <- st_intersects(s_sf, st_buffer(ucrb, 10000), sparse = FALSE)
s_ucrb <- s_sf[idx, ]



# impute coordinates
idx <- with(ldm_s2, !complete.cases(latitude_decimal_degrees, longitude_decimal_degrees))

```



# Map

```{r map}

st <- subset(st, ! state_name %in% c("Alaska", "Hawaii"))
bb <- st_bbox(ucrb)

s_ucrb$lab <- ifelse(!is.na(s_ucrb$pedlabsampnum), "KSSL", "field")


ggplot() +
  geom_sf(data = ucrb, fill = NA, col = "blue") +
  geom_sf(data = st, fill = NA) +
  geom_sf(data = s_ucrb, size = 0.00001, alpha = 0.15) +
  xlim(bb[c(1, 3)]) +
  ylim(bb[c(2, 4)]) +
  facet_wrap(~ lab) +
  # coord_sf(crs = "+init=epsg:5070") + 
  guides(fill = FALSE) +
  ggtitle("Location of Lab Data")

```